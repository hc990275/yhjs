import os
import requests
import subprocess
import sys
import shutil
import tkinter as tk
from tkinter import ttk, messagebox
import json
import threading
import concurrent.futures
from typing import Dict, List, Tuple, Optional, Any, Union
import time

# å¯¼å…¥ ttkbootstrap
import ttkbootstrap as tb
from ttkbootstrap.constants import *


class APKDownloader:
    """APK ä¸‹è½½ç®¡ç†å™¨ç±»ï¼Œå¤„ç†ç‰ˆæœ¬æ£€æŸ¥å’Œä¸‹è½½é€»è¾‘"""
    
    # é…ç½®å¸¸é‡
    VERSION_DIR = "F:/Program Files/Git/storage/SHä¸‹è½½æ–‡ä»¶/ç‰ˆæœ¬æ–‡ä»¶å¤¹"
    DOWNLOAD_DIR = "F:/Program Files/Git/storage/SHä¸‹è½½æ–‡ä»¶"
    USER_AGENT = "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/555.36 (KHTML, like Gecko) Chrome/121.0.0.0 Mobile Safari/555.36 EdgA/121.0.0.0"
    
    # ç‰ˆæœ¬ä¿¡æ¯URL
    URLS = {
        "OKç‰ˆæ‰‹æœº": "https://raw.githubusercontent.com/lystv/fmapp/main/apk/release/mobile.json",
        "OKç‰ˆç”µè§†": "https://raw.githubusercontent.com/lystv/fmapp/main/apk/release/leanback.json",
        "èœœèœ‚ç‰ˆæ‰‹æœº": "https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/release/mobile.json",
        "èœœèœ‚ç‰ˆç”µè§†": "https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/release/leanback.json",
        "OKç‰ˆPro": "https://raw.githubusercontent.com/lystv/fmapp/ok/apk/pro/v.txt"
    }
    
    # APKä¸‹è½½é“¾æ¥
    APK_LINKS = {
        "OKç‰ˆæ‰‹æœº_32": "lystv/fmapp/main/apk/release/mobile-armeabi_v7a.apk",
        "OKç‰ˆæ‰‹æœº_64": "lystv/fmapp/main/apk/release/mobile-arm64_v8a.apk",
        "OKç‰ˆç”µè§†_32": "lystv/fmapp/main/apk/release/leanback-armeabi_v7a.apk",
        "OKç‰ˆç”µè§†_64": "lystv/fmapp/main/apk/release/leanback-arm64_v8a.apk",
        "OKæµ·ä¿¡ä¸“ç‰ˆ_APK": "lystv/fmapp/main/apk/release/%E6%B5%B7%E4%BF%A1%E4%B8%93%E7%89%88.apk",
        "OKå®‰å“4ç‰ˆæœ¬_APK": "lystv/fmapp/main/apk/kitkat/leanback.apk",
        "OKç‰ˆPro_æ‰‹æœºPro": "lystv/fmapp/ok/apk/pro/mobile-pro.apk",
        "OKç‰ˆPro_æ‰‹æœºemu-Pro": "lystv/fmapp/ok/apk/pro/mobile-emu-pro.apk",
        "OKç‰ˆPro_ç”µè§†Pro": "lystv/fmapp/ok/apk/pro/leanback-pro.apk",
        "èœœèœ‚ç‰ˆæ‰‹æœº_32": "FongMi/Release/fongmi/apk/release/mobile-armeabi_v7a.apk",
        "èœœèœ‚ç‰ˆæ‰‹æœº_64": "FongMi/Release/fongmi/apk/release/mobile-arm64_v8a.apk",
        "èœœèœ‚ç‰ˆç”µè§†_32": "FongMi/Release/fongmi/apk/release/leanback-armeabi_v7a.apk",
        "èœœèœ‚ç‰ˆç”µè§†_64": "FongMi/Release/fongmi/apk/release/leanback-arm64_v8a.apk",
    }
    
    # ç‰ˆæœ¬ä¸APKæ˜ å°„å…³ç³»
    VERSION_TO_APKS = {
        "OKç‰ˆPro": ["OKç‰ˆPro_æ‰‹æœºPro", "OKç‰ˆPro_æ‰‹æœºemu-Pro", "OKç‰ˆPro_ç”µè§†Pro"],
        "OKç‰ˆæ‰‹æœº": ["OKç‰ˆæ‰‹æœº_32", "OKç‰ˆæ‰‹æœº_64", "OKæµ·ä¿¡ä¸“ç‰ˆ_APK"],
        "OKç‰ˆç”µè§†": ["OKç‰ˆç”µè§†_32", "OKç‰ˆç”µè§†_64"],
        "èœœèœ‚ç‰ˆæ‰‹æœº": ["èœœèœ‚ç‰ˆæ‰‹æœº_32", "èœœèœ‚ç‰ˆæ‰‹æœº_64"],
        "èœœèœ‚ç‰ˆç”µè§†": ["èœœèœ‚ç‰ˆç”µè§†_32", "èœœèœ‚ç‰ˆç”µè§†_64"]
    }
    
    def __init__(self, log_callback, progress_callback):
        """åˆå§‹åŒ–ä¸‹è½½å™¨
        
        Args:
            log_callback: æ—¥å¿—è¾“å‡ºå›è°ƒå‡½æ•°
            progress_callback: è¿›åº¦æ›´æ–°å›è°ƒå‡½æ•°
        """
        self.log = log_callback
        self.update_progress = progress_callback
        self.session = requests.Session()
        self.session.headers.update({'User-Agent': self.USER_AGENT})
        self.executor = concurrent.futures.ThreadPoolExecutor(max_workers=3)
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        os.makedirs(self.VERSION_DIR, exist_ok=True)
        os.makedirs(self.DOWNLOAD_DIR, exist_ok=True)
    
    def check_json_update(self, name: str) -> Tuple[str, bool]:
        """æ£€æŸ¥æŒ‡å®šç‰ˆæœ¬æ˜¯å¦æœ‰æ›´æ–°
        
        Args:
            name: ç‰ˆæœ¬åç§°
            
        Returns:
            Tuple[str, bool]: (æ–°ç‰ˆæœ¬å·, æ˜¯å¦æœ‰æ›´æ–°)
        """
        url = self.URLS[name]
        old_json_file = os.path.join(self.VERSION_DIR, f"{name}.json")
        new_json_file_temp = os.path.join(self.VERSION_DIR, f"{name}ä¸´æ—¶.json")
        self.log(f"æ­£åœ¨æ£€æŸ¥ {name} çš„ç‰ˆæœ¬...")
        
        try:
            response = self.session.get(url, timeout=10)
            response.raise_for_status()
            with open(new_json_file_temp, 'wb') as f:
                f.write(response.content)
            self.log(f"æˆåŠŸä¸‹è½½ {name} çš„æ–°ç‰ˆæœ¬ä¿¡æ¯.")
        except Exception as e:
            self.log(f"âš ï¸ ä¸‹è½½ {name} ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥ï¼Œé”™è¯¯ï¼š{e}")
            self._safe_remove(new_json_file_temp)
            return "", False

        old_version = ""
        new_version = ""

        try:
            if name == "OKç‰ˆPro":
                # å¤„ç†Proç‰ˆæœ¬çš„ç‰¹æ®Šæ ¼å¼
                if os.path.exists(old_json_file):
                    with open(old_json_file, "r", encoding='utf-8') as f:
                        old_version = f.readline().strip()
                with open(new_json_file_temp, "r", encoding='utf-8') as f:
                    new_version = f.readline().strip()
            else:
                # å¤„ç†æ ‡å‡†JSONæ ¼å¼
                if os.path.isfile(old_json_file):
                    with open(old_json_file, 'r', encoding='utf-8') as f:
                        old_json_data = json.load(f)
                        old_version = old_json_data.get("name", "")
                with open(new_json_file_temp, 'r', encoding='utf-8') as f:
                    new_json_data = json.load(f)
                    new_version = new_json_data.get("name", "")
        except Exception as e:
            self.log(f"âš ï¸ è§£æç‰ˆæœ¬ä¿¡æ¯å¤±è´¥: {e}")
            new_version = "" if not new_version else new_version
        finally:
            self._safe_remove(new_json_file_temp)

        self.log(f"{name} æ—§ç‰ˆæœ¬å·: {old_version if old_version else 'æœªæ‰¾åˆ°'}")
        self.log(f"{name} æ–°ç‰ˆæœ¬å·: {new_version if new_version else 'æœªæ‰¾åˆ°'}")
        
        return new_version, (new_version and new_version != old_version)
    
    def update_local_version_file(self, name: str, new_version_content: str) -> bool:
        """æ›´æ–°æœ¬åœ°ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        
        Args:
            name: ç‰ˆæœ¬åç§°
            new_version_content: æ–°ç‰ˆæœ¬å†…å®¹
            
        Returns:
            bool: æ˜¯å¦æˆåŠŸæ›´æ–°
        """
        version_file_path = os.path.join(self.VERSION_DIR, f"{name}.json")
        try:
            with open(version_file_path, 'w', encoding='utf-8') as f:
                if name == "OKç‰ˆPro":
                    f.write(new_version_content)
                else:
                    json.dump({"name": new_version_content}, f, ensure_ascii=False, indent=2)
            self.log(f"æœ¬åœ° {name} ç‰ˆæœ¬ä¿¡æ¯å·²æ›´æ–°ä¸º: {new_version_content}")
            return True
        except Exception as e:
            self.log(f"âŒ æ›´æ–°æœ¬åœ° {name} ç‰ˆæœ¬æ–‡ä»¶å¤±è´¥: {e}")
            return False
    
    def download_apk(self, apk_name: str) -> bool:
        """ä¸‹è½½æŒ‡å®šçš„APKæ–‡ä»¶
        
        Args:
            apk_name: APKåç§°
            
        Returns:
            bool: æ˜¯å¦æˆåŠŸä¸‹è½½
        """
        self.update_progress(0)
        try:
            relative_path = self.APK_LINKS[apk_name]
            apk_url = f"https://raw.githubusercontent.com/{relative_path}"
        except KeyError:
            self.log(f"é”™è¯¯ï¼šåœ¨ APK_LINKS ä¸­æœªæ‰¾åˆ°åç§°ä¸º '{apk_name}' çš„æ¡ç›®ï¼Œæ— æ³•æ„å»ºä¸‹è½½ URLã€‚")
            self.update_progress(0)
            return False

        clean_apk_name = apk_name.replace("_APK", "")
        apk_path = os.path.join(self.DOWNLOAD_DIR, f"{clean_apk_name}.apk")
        self.log(f"ğŸ“¥ æ­£åœ¨ä¸‹è½½: {clean_apk_name}.apk")

        try:
            response = self.session.get(apk_url, stream=True, timeout=60)
            response.raise_for_status()
            total_size = int(response.headers.get('content-length', 0))
            downloaded = 0
            
            with open(apk_path, 'wb') as f:
                for data in response.iter_content(chunk_size=8192):
                    f.write(data)
                    downloaded += len(data)
                    if total_size > 0:
                        progress = int((downloaded / total_size) * 100)
                        self.update_progress(progress)
            
            self.log(f"âœ… ä¸‹è½½å®Œæˆ: {clean_apk_name}.apk")
            self.update_progress(100)
            return True
        except Exception as e:
            self.log(f"âŒ APK ä¸‹è½½å¤±è´¥ï¼Œé”™è¯¯ï¼š{e}")
            self.update_progress(0)
            self._safe_remove(apk_path)
            return False
    
    def download_version_apks(self, name: str, force_download: bool = False) -> bool:
        """ä¸‹è½½æŒ‡å®šç‰ˆæœ¬çš„æ‰€æœ‰APKæ–‡ä»¶
        
        Args:
            name: ç‰ˆæœ¬åç§°
            force_download: æ˜¯å¦å¼ºåˆ¶ä¸‹è½½
            
        Returns:
            bool: æ˜¯å¦æˆåŠŸä¸‹è½½
        """
        self.update_progress(0)
        self.log(f"\n--- æ­£åœ¨æ£€æŸ¥ {name} æ˜¯å¦æœ‰æ›´æ–°... ---")
        
        try:
            new_version_info, has_update = self.check_json_update(name)
            if not new_version_info:
                self.log(f"æœªèƒ½è·å– {name} çš„æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼Œè·³è¿‡ä¸‹è½½ã€‚")
                return False
                
            if force_download or has_update:
                action_text = "å¼ºåˆ¶ä¸‹è½½" if force_download else "æ£€æµ‹åˆ°æœ‰æ›´æ–°"
                self.log(f"\nğŸ§© {name} {action_text}ï¼Œå‡†å¤‡ä¸‹è½½ç›¸å…³ APKs...")
                
                # è·å–éœ€è¦ä¸‹è½½çš„APKåˆ—è¡¨
                apks_to_download = self.VERSION_TO_APKS.get(name, [])
                if not apks_to_download:
                    self.log(f"âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ° {name} å¯¹åº”çš„APKä¸‹è½½åˆ—è¡¨")
                    return False
                
                # ä½¿ç”¨çº¿ç¨‹æ± å¹¶å‘ä¸‹è½½APK
                futures = []
                for apk_name in apks_to_download:
                    if apk_name in self.APK_LINKS:
                        futures.append(self.executor.submit(self.download_apk, apk_name))
                    else:
                        self.log(f"âš ï¸ è­¦å‘Š: APKåç§° '{apk_name}' æœªåœ¨ APK_LINKS å­—å…¸ä¸­æ‰¾åˆ°ï¼Œè·³è¿‡ä¸‹è½½ã€‚")
                
                # ç­‰å¾…æ‰€æœ‰ä¸‹è½½å®Œæˆ
                all_success = True
                for future in concurrent.futures.as_completed(futures):
                    if not future.result():
                        all_success = False
                
                # æ›´æ–°æœ¬åœ°ç‰ˆæœ¬ä¿¡æ¯
                if new_version_info:
                    self.update_local_version_file(name, new_version_info)
                
                self.log(f"--- {name} ä¸‹è½½ä»»åŠ¡å®Œæˆ ---")
                self.update_progress(100)
                return all_success
            else:
                self.log(f"--- {name} ç‰ˆæœ¬æœªå˜æ›´ï¼Œæ— éœ€ä¸‹è½½ ---")
                self.update_progress(100)
                return True
        except Exception as e:
            self.log(f"\nâš ï¸ {name} ä»»åŠ¡å¼‚å¸¸ç»ˆæ­¢: {e}")
            self.update_progress(0)
            return False
    
    def download_all_versions(self) -> bool:
        """ä¸‹è½½æ‰€æœ‰æœ‰æ›´æ–°çš„ç‰ˆæœ¬
        
        Returns:
            bool: æ˜¯å¦å…¨éƒ¨æˆåŠŸ
        """
        self.log("--- å¼€å§‹æ£€æŸ¥æ‰€æœ‰ç‰ˆæœ¬æ›´æ–° ---")
        self.update_progress(0)
        
        try:
            all_success = True
            total_versions = len(self.URLS)
            for i, name in enumerate(self.URLS.keys()):
                self.update_progress(int((i / total_versions) * 100))
                
                new_version_info, has_update = self.check_json_update(name)
                if not new_version_info:
                    self.log(f"æœªèƒ½è·å– {name} çš„æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼Œè·³è¿‡ä¸‹è½½ã€‚")
                    continue
                    
                if has_update:
                    if not self.download_version_apks(name):
                        all_success = False
                else:
                    self.log(f"--- {name} ç‰ˆæœ¬æœªå˜æ›´ï¼Œæ— éœ€ä¸‹è½½ ---")
            
            self.log("\n--- æ‰€æœ‰ç‰ˆæœ¬æ£€æŸ¥å’Œæ›´æ–°å®Œæˆ ---")
            self.update_progress(100)
            return all_success
        except Exception as e:
            self.log(f"\nâš ï¸ æ›´æ–°è¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯: {e}")
            self.update_progress(0)
            return False
    
    def download_kitkat_version(self) -> bool:
        """ä¸‹è½½å®‰å“4ç‰ˆæœ¬
        
        Returns:
            bool: æ˜¯å¦æˆåŠŸ
        """
        try:
            self.log("--- å¼€å§‹ä¸‹è½½ OK å®‰å“4ç‰ˆæœ¬ ---")
            self.update_progress(0)
            result = self.download_apk("OKå®‰å“4ç‰ˆæœ¬_APK")
            self.log("--- OK å®‰å“4ç‰ˆæœ¬ä¸‹è½½å®Œæˆ ---")
            return result
        except Exception as e:
            self.log(f"âš ï¸ ä¸‹è½½ OK å®‰å“4ç‰ˆæœ¬ä»»åŠ¡å¼‚å¸¸ç»ˆæ­¢: {e}")
            self.update_progress(0)
            return False
    
    def _safe_remove(self, file_path: str) -> None:
        """å®‰å…¨åˆ é™¤æ–‡ä»¶
        
        Args:
            file_path: æ–‡ä»¶è·¯å¾„
        """
        if os.path.exists(file_path):
            try:
                os.remove(file_path)
            except Exception as e:
                self.log(f"âš ï¸ åˆ é™¤æ–‡ä»¶å¤±è´¥: {file_path} - {e}")


class APKDownloaderGUI:
    """APKä¸‹è½½å™¨å›¾å½¢ç•Œé¢ç±»"""
    
    def __init__(self):
        """åˆå§‹åŒ–GUI"""
        # ä½¿ç”¨ 'superhero' ä¸»é¢˜ï¼Œè¿™æ˜¯ä¸€ä¸ªç°ä»£æ·±è‰²ä¸»é¢˜
        self.root = tb.Window(themename="superhero")
        self.root.title("APK æ›´æ–°ä¸‹è½½å·¥å…·")
        self.root.geometry("900x750")  # ç¨å¾®å¢å¤§çª—å£å°ºå¯¸
        self.root.resizable(True, True)
        
        # åˆ›å»ºä¸‹è½½å™¨å®ä¾‹
        self.downloader = APKDownloader(
            log_callback=self.append_log_safe,
            progress_callback=self.update_progress_safe
        )
        
        # åˆ›å»ºç•Œé¢å…ƒç´ 
        self._create_widgets()
        
        # åˆå§‹æ¶ˆæ¯
        self.append_log_safe("æ¬¢è¿ä½¿ç”¨ APK æ›´æ–°ä¸‹è½½å·¥å…·ï¼è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹æ“ä½œã€‚")
    
    def _create_widgets(self):
        """åˆ›å»ºç•Œé¢å…ƒç´ """
        # ä¸»æ¡†æ¶ï¼Œå¢åŠ æ•´ä½“å†…å¤–è¾¹è·
        self.main_frame = ttk.Frame(self.root, padding=(30, 20))  # å·¦å³30ï¼Œä¸Šä¸‹20
        self.main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        self.root.columnconfigure(0, weight=1)
        self.root.rowconfigure(0, weight=1)
        
        # ç¡®ä¿æ‰€æœ‰åˆ—éƒ½èƒ½å‡åŒ€æ‹‰ä¼¸
        for i in range(4):
            self.main_frame.columnconfigure(i, weight=1)
        self.main_frame.rowconfigure(4, weight=1)  # è®©æ—¥å¿—æ–‡æœ¬æ¡†æ‰€åœ¨çš„è¡Œå¯ä¼¸ç¼©
        
        # --- æŒ‰é’®å¸ƒå±€ ---
        # é¡¶éƒ¨ä¸»æ§åˆ¶æŒ‰é’® (ç¬¬ä¸€è¡Œ)
        self.start_button = ttk.Button(
            self.main_frame, 
            text="æ£€æŸ¥å¹¶æ›´æ–°æ‰€æœ‰ç‰ˆæœ¬", 
            bootstyle="primary",
            command=self._run_all_updates
        )
        
        self.open_dir_button = ttk.Button(
            self.main_frame, 
            text="æ‰“å¼€ä¸‹è½½ç›®å½•", 
            bootstyle="info",
            command=self._open_download_directory
        )
        
        self.kitkat_button = ttk.Button(
            self.main_frame, 
            text="ä¸‹è½½ OKå®‰å“4ç‰ˆæœ¬", 
            bootstyle="warning",
            command=self._run_kitkat_download
        )
        
        self.start_button.grid(row=0, column=0, columnspan=2, padx=(0, 10), pady=15, sticky=(tk.W, tk.E))
        self.open_dir_button.grid(row=0, column=2, padx=(10, 5), pady=15, sticky=(tk.W, tk.E))
        self.kitkat_button.grid(row=0, column=3, padx=(5, 0), pady=15, sticky=(tk.W, tk.E))
        
        # å„ç‰ˆæœ¬ç‹¬ç«‹ä¸‹è½½æŒ‰é’® (ç¬¬äºŒã€ä¸‰è¡Œ)
        button_opts = {'padx': 5, 'pady': 10, 'sticky': (tk.W, tk.E)}  # å®šä¹‰é€šç”¨æŒ‰é’®é€‰é¡¹
        
        self.ok_mobile_button = ttk.Button(
            self.main_frame, 
            text="ä¸‹è½½ OKç‰ˆæ‰‹æœº (å¦‚æœ‰æ›´æ–°)", 
            bootstyle="success",
            command=lambda: self._run_version_download("OKç‰ˆæ‰‹æœº")
        )
        
        self.ok_tv_button = ttk.Button(
            self.main_frame, 
            text="ä¸‹è½½ OKç‰ˆç”µè§† (å¦‚æœ‰æ›´æ–°)", 
            bootstyle="success",
            command=lambda: self._run_version_download("OKç‰ˆç”µè§†")
        )
        
        self.ok_pro_button = ttk.Button(
            self.main_frame, 
            text="ä¸‹è½½ OKç‰ˆPro (å¦‚æœ‰æ›´æ–°)", 
            bootstyle="success",
            command=lambda: self._run_version_download("OKç‰ˆPro")
        )
        
        self.ok_mobile_button.grid(row=1, column=0, **button_opts)
        self.ok_tv_button.grid(row=1, column=1, **button_opts)
        self.ok_pro_button.grid(row=1, column=2, **button_opts)
        
        self.mf_mobile_button = ttk.Button(
            self.main_frame, 
            text="ä¸‹è½½ èœœèœ‚ç‰ˆæ‰‹æœº (å¦‚æœ‰æ›´æ–°)", 
            bootstyle="info",
            command=lambda: self._run_version_download("èœœèœ‚ç‰ˆæ‰‹æœº")
        )
        
        self.mf_tv_button = ttk.Button(
            self.main_frame, 
            text="ä¸‹è½½ èœœèœ‚ç‰ˆç”µè§† (å¦‚æœ‰æ›´æ–°)", 
            bootstyle="info",
            command=lambda: self._run_version_download("èœœèœ‚ç‰ˆç”µè§†")
        )
        
        self.mf_mobile_button.grid(row=2, column=0, **button_opts)
        self.mf_tv_button.grid(row=2, column=1, **button_opts)
        
        # æ—¥å¿—æ ‡ç­¾å’Œæ–‡æœ¬æ¡†
        self.log_label = ttk.Label(
            self.main_frame, 
            text="æ—¥å¿—è¾“å‡º:", 
            bootstyle="secondary", 
            font=('å¾®è½¯é›…é»‘', 12, 'bold')
        )
        self.log_label.grid(row=3, column=0, sticky=tk.W, pady=(20, 5))  # å¢åŠ ä¸Šå†…è¾¹è·
        
        self.log_text = tk.Text(
            self.main_frame, 
            height=18, 
            width=70, 
            wrap=tk.WORD,
            bg="#2a2a2a", 
            fg="#e0e0e0", 
            relief=tk.FLAT,  # è°ƒæ•´å­—ä½“é¢œè‰²ï¼Œæ›´æŸ”å’Œ
            font=('Consolas', 11)  # ç¨å¾®å¢å¤§å­—ä½“
        )
        
        self.log_scrollbar = ttk.Scrollbar(
            self.main_frame, 
            command=self.log_text.yview, 
            bootstyle="round"
        )
        
        self.log_scrollbar.grid(row=4, column=4, sticky=(tk.N, tk.S))
        self.log_text['yscrollcommand'] = self.log_scrollbar.set
        self.log_text.grid(row=4, column=0, columnspan=4, padx=5, pady=5, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        # è¿›åº¦æ ‡ç­¾å’Œè¿›åº¦æ¡
        self.progress_label = ttk.Label(
            self.main_frame, 
            text="å½“å‰ä»»åŠ¡è¿›åº¦:", 
            bootstyle="secondary", 
            font=('å¾®è½¯é›…é»‘', 12, 'bold')
        )
        self.progress_label.grid(row=5, column=0, sticky=tk.W, pady=(20, 5))  # å¢åŠ ä¸Šå†…è¾¹è·
        
        self.progress_bar = ttk.Progressbar(
            self.main_frame, 
            orient="horizontal", 
            mode="determinate", 
            bootstyle="striped.success",
            length=700  # æ˜ç¡®æŒ‡å®šé•¿åº¦ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´å®½
        )
        self.progress_bar.grid(row=6, column=0, columnspan=4, padx=5, pady=10, sticky=(tk.W, tk.E))
    
    # --- GUI æ›´æ–°å‡½æ•° ---
    def append_log_safe(self, message: str) -> None:
        """çº¿ç¨‹å®‰å…¨çš„æ—¥å¿—è¿½åŠ 
        
        Args:
            message: æ—¥å¿—æ¶ˆæ¯
        """
        self.root.after(0, self._append_log_gui, message)
    
    def _append_log_gui(self, message: str) -> None:
        """åœ¨GUIçº¿ç¨‹ä¸­è¿½åŠ æ—¥å¿—
        
        Args:
            message: æ—¥å¿—æ¶ˆæ¯
        """
        self.log_text.insert(tk.END, message + "\n")
        self.log_text.yview(tk.END)
    
    def update_progress_safe(self, value: int) -> None:
        """çº¿ç¨‹å®‰å…¨çš„è¿›åº¦æ›´æ–°
        
        Args:
            value: è¿›åº¦å€¼(0-100)
        """
        self.root.after(0, self._update_progress_gui, value)
    
    def _update_progress_gui(self, value: int) -> None:
        """åœ¨GUIçº¿ç¨‹ä¸­æ›´æ–°è¿›åº¦æ¡
        
        Args:
            value: è¿›åº¦å€¼(0-100)
        """
        self.progress_bar['value'] = value
    
    def set_all_buttons_state(self, state: str) -> None:
        """è®¾ç½®æ‰€æœ‰æŒ‰é’®çŠ¶æ€
        
        Args:
            state: æŒ‰é’®çŠ¶æ€(tk.NORMALæˆ–tk.DISABLED)
        """
        self.root.after(0, self._set_all_buttons_gui, state)
    
    def _set_all_buttons_gui(self, state: str) -> None:
        """åœ¨GUIçº¿ç¨‹ä¸­è®¾ç½®æ‰€æœ‰æŒ‰é’®çŠ¶æ€
        
        Args:
            state: æŒ‰é’®çŠ¶æ€
        """
        buttons = [
            self.start_button, 
            self.open_dir_button, 
            self.kitkat_button,
            self.ok_mobile_button, 
            self.ok_tv_button, 
            self.ok_pro_button,
            self.mf_mobile_button, 
            self.mf_tv_button
        ]
        
        for button in buttons:
            if button.winfo_exists():
                button.config(state=state)
    
    # --- åŠŸèƒ½å‡½æ•° ---
    def _open_download_directory(self) -> None:
        """æ‰“å¼€ä¸‹è½½ç›®å½•"""
        target_dir = os.path.realpath(self.downloader.DOWNLOAD_DIR)
        self.append_log_safe(f"å°è¯•æ‰“å¼€ç›®å½•: {target_dir}")
        
        try:
            if sys.platform == "win32":
                os.startfile(target_dir)
            elif sys.platform == "darwin":
                subprocess.run(['open', target_dir], check=True)
            elif sys.platform.startswith('linux'):
                subprocess.run(['xdg-open', target_dir], check=True)
            else:
                self.append_log_safe(f"âš ï¸ è­¦å‘Š: ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ '{sys.platform}'ï¼Œæ— æ³•è‡ªåŠ¨æ‰“å¼€ç›®å½•ã€‚")
                return
            self.append_log_safe("æˆåŠŸæ‰“å¼€ä¸‹è½½ç›®å½•ã€‚")
        except Exception as e:
            self.append_log_safe(f"âŒ æ‰“å¼€ç›®å½•æ—¶å‘ç”Ÿé”™è¯¯: {e}")
    
    def _run_version_download(self, name: str, force: bool = False) -> None:
        """è¿è¡Œç‰ˆæœ¬ä¸‹è½½ä»»åŠ¡
        
        Args:
            name: ç‰ˆæœ¬åç§°
            force: æ˜¯å¦å¼ºåˆ¶ä¸‹è½½
        """
        self.set_all_buttons_state(tk.DISABLED)
        
        def task():
            try:
                self.downloader.download_version_apks(name, force)
            finally:
                self.set_all_buttons_state(tk.NORMAL)
        
        threading.Thread(target=task, daemon=True).start()
    
    def _run_all_updates(self) -> None:
        """è¿è¡Œæ‰€æœ‰æ›´æ–°ä»»åŠ¡"""
        self.set_all_buttons_state(tk.DISABLED)
        
        def task():
            try:
                self.downloader.download_all_versions()
            finally:
                self.set_all_buttons_state(tk.NORMAL)
        
        threading.Thread(target=task, daemon=True).start()
    
    def _run_kitkat_download(self) -> None:
        """è¿è¡Œå®‰å“4ç‰ˆæœ¬ä¸‹è½½ä»»åŠ¡"""
        self.set_all_buttons_state(tk.DISABLED)
        
        def task():
            try:
                self.downloader.download_kitkat_version()
            finally:
                self.set_all_buttons_state(tk.NORMAL)
        
        threading.Thread(target=task, daemon=True).start()
    
    def run(self) -> None:
        """è¿è¡ŒGUIä¸»å¾ªç¯"""
        self.root.mainloop()


# ç¨‹åºå…¥å£ç‚¹
if __name__ == "__main__":
    app = APKDownloaderGUI()
    app.run()